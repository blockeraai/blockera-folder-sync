const e=require("@actions/core"),a=require("@actions/github"),o=require("simple-git"),t=(require("fs"),require("path")),r=require("./helpers"),i=async()=>{try{const i=o();await i.addConfig("user.name","blockerabot"),await i.addConfig("user.email","blockeraai+githubbot@gmail.com");const{packagePaths:c,packageRepos:s}=r();e.info("Package paths: "+c),e.info("Dependent repos: "+s);const n=await i.diff(["--name-only","HEAD^","HEAD"]);c.forEach(a=>{n.includes(a)?e.info("Changes detected in package at "+a):e.info("No changes detected in "+a)});for(const o of s){const r=t.join("./",o);await i.clone(`https://github.com/blockeraai/${o}.git`,r),await i.cwd(r),await i.remote(["set-url","origin",`https://x-access-token:${process.env.BLOCKERABOT_PAT}@github.com/blockeraai/${o}.git`]);for(const s of c)if(o!==a.context.repo.repo){const a=t.join("./",s),o=t.join(r,s);await i.raw(["rsync","-av","--progress",a,o,"--delete"]),e.info(`Synced package from ${a} to ${o}`)}await i.checkout(["-b","sync-packages-from-primary"]),await i.add("./*"),await i.commit("Sync shared packages from primary repo"),await i.push("origin","sync-packages-from-primary"),e.info("Changes pushed to "+o);const s=a.getOctokit(process.env.GITHUB_TOKEN);await s.pulls.create({owner:a.context.repo.owner,repo:o,title:"Sync package from Primary Repo",head:"sync-packages-from-primary",base:"master",body:"This PR syncs the package from the "+process.env.REPOSITORY_NAME+" repo."})}}catch(a){e.setFailed(a.message)}};i().catch(a=>{e.setFailed(a.message)}),module.exports={run:i};
